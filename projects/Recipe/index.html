<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåô Smart Recipe Book</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg:#fdf6ec;--card:#fff;--text:#333;--primary:#ff7043;--shadow:0 20px 40px rgba(0,0,0,.1)
}
body.dark{
  --bg:#121212;--card:#1f1f1f;--text:#f5f5f5;--primary:#ffab91
}
body{margin:0;font-family:Poppins;background:var(--bg);color:var(--text);transition:.3s}
header{display:flex;justify-content:space-between;align-items:center;padding:25px}
button{border:none;border-radius:20px;padding:10px 16px;cursor:pointer;background:var(--primary);color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:25px;padding:25px}
.card{background:var(--card);border-radius:20px;box-shadow:var(--shadow);overflow:hidden;transition:.3s}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;height:160px;object-fit:cover}
.card .info{padding:15px}
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
.modal-content{background:var(--card);padding:25px;border-radius:20px;width:90%;max-width:650px;max-height:85vh;overflow:auto}
input,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #ccc;margin:6px 0}
.timer{font-size:1.2rem;margin:10px 0}
.favorite{font-size:1.3rem;cursor:pointer}
.format-badge{
  position:absolute;top:5px;right:5px;background:rgba(76,175,80,0.9);
  color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:bold;
}
.format-warning{
  background:#fff3cd;border:1px solid #ffeaa7;padding:8px;border-radius:5px;
  margin:10px 0;font-size:12px;color:#856404;
}
.format-info{
  background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:5px;
  margin:10px 0;font-size:12px;color:#1565c0;
}
.btn-small{font-size:11px;padding:4px 8px;margin-left:5px;border-radius:4px;}
.image-container{position:relative;overflow:hidden;}
.image-container img{transition:transform 0.2s ease;}
.image-container:hover img{transform:scale(1.02);}
</style>
</head>
<body>
<header>
<h1>üç≤ Smart Recipe Book</h1>
<div>
<button onclick="toggleTheme()">üåô Toggle</button>
<button onclick="openAdd()">‚ûï Add</button>
</div>
</header>

<div class="grid" id="recipes"></div>

<div class="modal" id="modal"></div>

<script>
const { jsPDF } = window.jspdf;

// Image format configuration
const IMAGE_CONFIG = {
  // Local PNG fallbacks for recipes that require PNG format
  localFallbacks: {
    'Pancakes': 'assets/images/pancakes-placeholder.svg',
    'Veg Biryani': 'assets/images/biryani-placeholder.svg',
    'Margherita Pizza': 'assets/images/pizza-placeholder.svg'
  },
  // Define which recipes require PNG format
  pngRequired: ['Pancakes', 'Veg Biryani'],
  // Supported formats
  supportedFormats: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/svg+xml'],
  // Default fallback
  defaultFallback: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjI0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzZiNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='
};

let recipes = JSON.parse(localStorage.getItem('recipes')) || [
 {id:1,title:'Veg Biryani',img:'https://images.unsplash.com/photo-1600628422019-8a0b8e7c7d5d',ingredients:['Rice','Vegetables','Spices'],steps:['Cook rice','Prepare masala','Mix & steam'],time:900,requiresPNG:true},
 {id:2,title:'Margherita Pizza',img:'https://images.unsplash.com/photo-1604382354936-07c5d9983bd3',ingredients:['Flour','Cheese','Tomato Sauce'],steps:['Prepare dough','Add toppings','Bake'],time:800},
 {id:3,title:'Pancakes',img:'https://images.unsplash.com/photo-1587732019718-4a4e7f5b6a2d',ingredients:['Flour','Milk','Eggs'],steps:['Make batter','Cook on pan','Serve hot'],time:400,requiresPNG:true},
 {id:4,title:'Caesar Salad',img:'https://images.unsplash.com/photo-1568605114967-8130f3a36994',ingredients:['Lettuce','Croutons','Dressing'],steps:['Chop','Mix','Serve'],time:300},
 {id:5,title:'Chocolate Brownies',img:'https://images.unsplash.com/photo-1599785209707-a456fc1337bb',ingredients:['Cocoa','Butter','Sugar','Flour'],steps:['Mix ingredients','Bake','Cool & slice'],time:700},
 {id:6,title:'Masala Dosa',img:'https://images.unsplash.com/photo-1626776876729-bab4360a7b19',ingredients:['Rice batter','Potato','Spices'],steps:['Prepare filling','Spread batter','Cook & fold'],time:600}
];
let favs = JSON.parse(localStorage.getItem('favs')) || [];

function save(){localStorage.setItem('recipes',JSON.stringify(recipes));localStorage.setItem('favs',JSON.stringify(favs));}

function toggleTheme(){document.body.classList.toggle('dark')}

// Image format detection and handling
function detectImageFormat(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 1;
      canvas.height = 1;
      
      try {
        ctx.drawImage(img, 0, 0, 1, 1);
        const imageData = ctx.getImageData(0, 0, 1, 1);
        // Simple heuristic: if alpha channel is used, likely supports transparency
        const hasTransparency = imageData.data[3] < 255;
        
        // Check if URL suggests PNG but image doesn't support transparency
        const urlSuggestsPNG = url.toLowerCase().includes('.png');
        const actualFormat = hasTransparency ? 'PNG-like' : 'JPEG-like';
        
        resolve({
          hasTransparency,
          urlSuggestsPNG,
          actualFormat,
          formatMismatch: urlSuggestsPNG && !hasTransparency
        });
      } catch (e) {
        // CORS error or other issue - assume external JPEG
        resolve({
          hasTransparency: false,
          urlSuggestsPNG: url.toLowerCase().includes('.png'),
          actualFormat: 'JPEG (external)',
          formatMismatch: url.toLowerCase().includes('.png')
        });
      }
    };
    
    img.onerror = () => {
      resolve({
        hasTransparency: false,
        urlSuggestsPNG: false,
        actualFormat: 'Error loading',
        formatMismatch: false
      });
    };
    
    img.src = url;
  });
}

// Get the appropriate image URL with format handling
function getImageUrl(recipe) {
  // If recipe requires PNG and has a local fallback, use it
  if (recipe.requiresPNG && IMAGE_CONFIG.localFallbacks[recipe.title]) {
    return IMAGE_CONFIG.localFallbacks[recipe.title];
  }
  
  // For external URLs that might not support PNG, add format indicators
  if (recipe.img && recipe.img.includes('unsplash.com')) {
    // Unsplash always serves JPEG, so add format parameter to make it explicit
    return recipe.img + (recipe.img.includes('?') ? '&' : '?') + 'fm=jpg&q=80';
  }
  
  return recipe.img || IMAGE_CONFIG.defaultFallback;
}

// Enhanced render function with format validation
function render(){
 const el=document.getElementById('recipes');el.innerHTML='';
 recipes.forEach(r=>{
  const fav=favs.includes(r.id)?'‚ù§Ô∏è':'ü§ç';
  const imgUrl = getImageUrl(r);
  const formatBadge = r.requiresPNG ? '<div class="format-badge">üñºÔ∏è PNG</div>' : '';
  
  el.innerHTML+=`<div class="card">
    <div class="image-container">
      <img src="${imgUrl}" alt="${r.title}" style="width:100%;height:160px;object-fit:cover" onerror="this.src='${IMAGE_CONFIG.defaultFallback}'">
      ${formatBadge}
    </div>
    <div class="info">
      <h3>${r.title} <span class="favorite" onclick="favToggle(${r.id})">${fav}</span></h3>
      <div>
        <button onclick="openRecipe(${r.id})">View Recipe</button>
        ${r.requiresPNG ? '<button class="btn-small" onclick="checkImageFormat(' + r.id + ')" style="background:#4caf50;color:white;">Check Format</button>' : ''}
      </div>
    </div>
  </div>`
 })
}

function favToggle(id){favs.includes(id)?favs=favs.filter(f=>f!==id):favs.push(id);save();render()}

// Check and display image format information
async function checkImageFormat(id) {
  const recipe = recipes.find(x => x.id === id);
  if (!recipe) return;
  
  const originalUrl = recipe.img;
  const currentUrl = getImageUrl(recipe);
  
  try {
    const formatInfo = await detectImageFormat(originalUrl);
    
    let message = `üì∑ Image Format Analysis for "${recipe.title}"\n\n`;
    message += `Original URL: ${originalUrl}\n`;
    message += `Current URL: ${currentUrl}\n`;
    message += `Detected Format: ${formatInfo.actualFormat}\n`;
    message += `Has Transparency: ${formatInfo.hasTransparency ? 'Yes' : 'No'}\n`;
    message += `PNG Expected: ${recipe.requiresPNG ? 'Yes' : 'No'}\n\n`;
    
    if (formatInfo.formatMismatch) {
      message += `‚ö†Ô∏è FORMAT MISMATCH DETECTED!\n`;
      message += `This recipe expects PNG format but the image is served as JPEG.\n`;
      message += `Using local PNG fallback: ${IMAGE_CONFIG.localFallbacks[recipe.title] || 'Not available'}\n\n`;
    }
    
    if (originalUrl.includes('unsplash.com')) {
      message += `‚ÑπÔ∏è Note: Unsplash always serves images in JPEG format, regardless of the URL extension.\n`;
      message += `For PNG support, local assets or PNG-compatible sources should be used.`;
    }
    
    alert(message);
  } catch (error) {
    alert(`Error analyzing image format: ${error.message}`);
  }
}

function openRecipe(id){
 const r=recipes.find(x=>x.id===id);
 let t=r.time;
 const imgUrl = getImageUrl(r);
 const formatWarning = r.requiresPNG && r.img && r.img.includes('unsplash.com') ? 
   '<div class="format-warning">‚ö†Ô∏è <strong>Format Notice:</strong> This recipe requires PNG format for transparency support. External image served as JPEG. Using local PNG fallback for optimal display.</div>' : '';
   
 document.getElementById('modal').style.display='flex';
 document.getElementById('modal').innerHTML=`<div class="modal-content">
   <button onclick="closeModal()">‚úñ</button>
   <h2>${r.title} ${r.requiresPNG ? 'üñºÔ∏è' : ''}</h2>
   <div class="image-container">
     <img src="${imgUrl}" alt="${r.title}" style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;margin:10px 0;" onerror="this.src='${IMAGE_CONFIG.defaultFallback}'">
   </div>
   ${formatWarning}
   <p><b>Ingredients</b></p>
   <ul>${r.ingredients.map(i=>`<li>${i}</li>`).join('')}</ul>
   <p><b>Steps</b></p>
   <ol>${r.steps.map(s=>`<li>${s}</li>`).join('')}</ol>
   <div class="timer" id="timer">${t}s</div>
   <div>
     <button onclick="startTimer(${t})">üî• Start Timer</button>
     <button onclick="exportPDF(${id})" style="margin-left:5px;">üìÑ Export PDF</button>
     <button onclick="aiSuggest()" style="margin-left:5px;">üß† AI Suggest</button>
     ${r.requiresPNG ? '<button onclick="checkImageFormat(' + id + ')" style="margin-left:5px;background:#4caf50;color:white;">üîç Check Format</button>' : ''}
   </div>
 </div>`
}

function startTimer(sec){
 let t=sec;const el=document.getElementById('timer');
 const i=setInterval(()=>{t--;el.textContent=t+'s';if(t<=0){clearInterval(i);alert('‚è∞ Time Up!')}},1000)
}

function exportPDF(id){
 const r=recipes.find(x=>x.id===id);const pdf=new jsPDF();
 pdf.text(r.title,10,10);pdf.text('Ingredients:',10,20);
 r.ingredients.forEach((i,n)=>pdf.text('- '+i,10,30+n*8));
 pdf.save(r.title+'.pdf');
}

function aiSuggest(){alert('üß† AI Suggestion: Try adding herbs & olive oil for better flavor!')}

function openAdd(){
 document.getElementById('modal').style.display='flex';
 document.getElementById('modal').innerHTML=`<div class="modal-content">
   <button onclick="closeModal()">‚úñ</button>
   <h2>‚ûï Add New Recipe</h2>
   <div class="format-info">
     <strong>üìù Image Format Guidelines:</strong><br>
     ‚Ä¢ <strong>PNG Format:</strong> Required for recipes needing transparency support<br>
     ‚Ä¢ <strong>External Sources:</strong> Unsplash/Picsum serve JPEG regardless of URL extension<br>
     ‚Ä¢ <strong>Supported:</strong> JPEG, PNG, WebP, SVG ‚Ä¢ <strong>Max Size:</strong> 2MB<br>
     ‚Ä¢ <strong>Recommendation:</strong> Use local PNG files for transparency requirements
   </div>
   <input id="t" placeholder="Recipe Title (e.g., 'Fluffy Pancakes')">
   <input id="i" placeholder="Image URL (https://...)">
   <div style="margin:10px 0;">
     <label style="display:flex;align-items:center;gap:8px;">
       <input type="checkbox" id="pngRequired"> 
       <span>üñºÔ∏è This recipe requires PNG format (transparency/alpha channel support)</span>
     </label>
   </div>
   <textarea id="ing" placeholder="Ingredients (comma separated)&#10;e.g., Flour, Milk, Eggs, Baking Powder"></textarea>
   <textarea id="st" placeholder="Cooking Steps (comma separated)&#10;e.g., Mix dry ingredients, Add wet ingredients, Cook on pan"></textarea>
   <input id="time" type="number" placeholder="Cooking time in seconds" value="600" min="60" max="7200">
   <div style="margin-top:15px;">
     <button onclick="addRecipe()" style="background:#4caf50;">üíæ Save Recipe</button>
     <button onclick="closeModal()" style="background:#f44336;margin-left:10px;">‚ùå Cancel</button>
   </div>
 </div>`
}

function addRecipe(){
 const title = document.getElementById('t').value;
 const img = document.getElementById('i').value;
 const ingredients = document.getElementById('ing').value.split(',').map(i => i.trim()).filter(i => i);
 const steps = document.getElementById('st').value.split(',').map(s => s.trim()).filter(s => s);
 const time = parseInt(document.getElementById('time').value) || 600;
 const requiresPNG = document.getElementById('pngRequired').checked;
 
 if (!title || !img || ingredients.length === 0 || steps.length === 0) {
   alert('Please fill in all required fields');
   return;
 }
 
 // Validate image URL format
 const validImageExtensions = ['.jpg', '.jpeg', '.png', '.webp', '.svg'];
 const hasValidExtension = validImageExtensions.some(ext => 
   img.toLowerCase().includes(ext) || img.includes('unsplash.com') || img.includes('images.')
 );
 
 if (!hasValidExtension) {
   const proceed = confirm('Image URL doesn\'t appear to be a valid image. Continue anyway?');
   if (!proceed) return;
 }
 
 // Warning for PNG requirement with external URLs
 if (requiresPNG && (img.includes('unsplash.com') || img.includes('picsum.photos'))) {
   const proceed = confirm('‚ö†Ô∏è Warning: You\'ve marked this recipe as requiring PNG format, but you\'re using an external image source that typically serves JPEG. This may cause format inconsistency. Continue anyway?');
   if (!proceed) return;
 }
 
 const newRecipe = {
   id: Date.now(),
   title,
   img,
   ingredients,
   steps,
   time,
   requiresPNG
 };
 
 recipes.push(newRecipe);
 save();
 closeModal();
 render();
 
 // Show success message with format info
 const formatNote = requiresPNG ? ' (PNG format required - consider using local images for transparency support)' : '';
 alert(`‚úÖ Recipe "${title}" added successfully!${formatNote}`);
}
function closeModal(){document.getElementById('modal').style.display='none'}
render();
</script>
</body>
</html>
